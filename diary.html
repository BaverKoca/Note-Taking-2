<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Digital Diary - Evernote</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .diary-container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 30px;
    }

    /* Calendar Styles */
    .calendar-section {
      background: white;
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(59,130,246,0.13);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #2563eb;
    }

    .calendar-nav {
      display: flex;
      gap: 10px;
    }

    .calendar-nav button {
      background: #f3f4f6;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: #374151;
      font-weight: 500;
      transition: background 0.2s;
    }

    .calendar-nav button:hover {
      background: #e5e7eb;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .calendar-weekday {
      text-align: center;
      font-weight: 600;
      color: #6b7280;
      padding: 8px;
      font-size: 0.9rem;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      position: relative;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      transition: all 0.2s;
    }

    .calendar-day:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .calendar-day.has-entry {
      border-color: #3b82f6;
      font-weight: 600;
    }

    .calendar-day.today {
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }

    .calendar-day.selected {
      background: #2563eb;
      color: white;
      font-weight: 600;
    }

    .calendar-day.other-month {
      color: #9ca3af;
      background: #ffffff;
    }

    /* Entry Section Styles */
    .entry-section {
      background: white;
      border-radius: 18px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(59,130,246,0.13);
    }

    .entry-header {
      margin-bottom: 24px;
    }

    .entry-date {
      font-size: 1.5rem;
      font-weight: 600;
      color: #2563eb;
      margin: 0;
    }

    .entry-weekday {
      color: #6b7280;
      font-size: 1.1rem;
      margin-top: 4px;
    }

    .entry-editor {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .entry-title {
      width: 100%;
      padding: 12px 16px;
      font-size: 1.2rem;
      border-radius: 8px;
      border: 1.5px solid #e5e7eb;
      outline: none;
      transition: border-color 0.2s;
    }

    .entry-title:focus {
      border-color: #3b82f6;
    }

    .entry-content {
      width: 100%;
      min-height: 400px;
      padding: 16px;
      font-size: 1rem;
      line-height: 1.6;
      border-radius: 8px;
      border: 1.5px solid #e5e7eb;
      outline: none;
      resize: vertical;
      transition: border-color 0.2s;
    }

    .entry-content:focus {
      border-color: #3b82f6;
    }

    .entry-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }

    .save-entry {
      background: #00a82d;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .save-entry:hover {
      opacity: 0.9;
    }

    .delete-entry {
      background: #ef4444;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .delete-entry:hover {
      opacity: 0.9;
    }

    .status-message {
      text-align: center;
      margin-top: 12px;
      padding: 8px;
      border-radius: 6px;
      display: none;
    }

    .success-message {
      background: #dcfce7;
      color: #166534;
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
    }

    @media (max-width: 900px) {
      .diary-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo" id="logo-link">Evernote</div>
    <nav class="nav-links" style="position:relative;">
      <button id="profile-btn" class="profile-btn">Profile</button>
      <div id="profile-menu" class="profile-menu">
        <button class="profile-menu-btn" id="profile-menu-profile">Profile</button>
        <button class="profile-menu-btn" id="profile-menu-diary">Diary</button>
        <button class="profile-menu-btn" id="profile-menu-settings">Settings</button>
        <button class="profile-menu-btn" id="logout-link">Logout</button>
      </div>
    </nav>
  </header>

  <div class="diary-container">
    <div class="calendar-section">
      <div class="calendar-header">
        <h2 class="calendar-title">Calendar</h2>
        <div class="calendar-nav">
          <button id="prev-month">&lt; Prev</button>
          <button id="next-month">Next &gt;</button>
        </div>
      </div>
      <div id="calendar" class="calendar-grid">
        <!-- Calendar will be generated here -->
      </div>
    </div>

    <div class="entry-section">
      <div class="entry-header">
        <h1 class="entry-date" id="entry-date"></h1>
        <div class="entry-weekday" id="entry-weekday"></div>
      </div>
      <form class="entry-editor" id="entry-form">
        <input type="text" class="entry-title" id="entry-title" placeholder="Entry Title" required>
        <textarea class="entry-content" id="entry-content" placeholder="Write your thoughts for the day..." required></textarea>
        <div class="entry-actions">
          <button type="button" class="delete-entry" id="delete-entry">Delete Entry</button>
          <button type="submit" class="save-entry">Save Entry</button>
        </div>
      </form>
      <div id="success-message" class="status-message success-message">Entry saved successfully!</div>
      <div id="error-message" class="status-message error-message"></div>
    </div>
  </div>

  <script>
    // Session check
    fetch('/api/session', { credentials: 'include' })
      .then(r => r.json())
      .then(data => {
        if (!data.loggedIn) window.location.href = 'sign.html';
      });

    // Profile menu logic
    const profileBtn = document.getElementById('profile-btn');
    const profileMenu = document.getElementById('profile-menu');
    let menuOpen = false;
    profileBtn.onclick = function(e) {
      e.stopPropagation();
      menuOpen = !menuOpen;
      profileMenu.style.display = menuOpen ? 'flex' : 'none';
    };
    document.addEventListener('click', function(e) {
      if (menuOpen && !profileMenu.contains(e.target) && e.target !== profileBtn) {
        profileMenu.style.display = 'none';
        menuOpen = false;
      }
    });
    document.getElementById('profile-menu-profile').onclick = function() {
      window.location.href = 'profile.html';
    };
    document.getElementById('profile-menu-diary').onclick = function() {
      window.location.href = 'diary.html';
    };
    document.getElementById('profile-menu-settings').onclick = function() {
      window.location.href = 'settings.html';
    };
    document.getElementById('logout-link').onclick = function(e) {
      e.preventDefault();
      fetch('/api/logout', { method: 'POST', credentials: 'include' })
        .then(() => window.location.href = 'index.html');
    };

    // Calendar and Diary Logic
    let currentDate = new Date();
    let selectedDate = new Date();
    let entries = new Map(); // Store diary entries by date

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function formatDisplayDate(date) {
      return date.toLocaleDateString('en-US', { 
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    function updateEntryHeader() {
      document.getElementById('entry-date').textContent = selectedDate.toLocaleDateString('en-US', { 
        month: 'long',
        day: 'numeric',
        year: 'numeric'
      });
      document.getElementById('entry-weekday').textContent = selectedDate.toLocaleDateString('en-US', { 
        weekday: 'long'
      });
    }

    function generateCalendar() {
      const calendar = document.getElementById('calendar');
      calendar.innerHTML = '';

      // Add weekday headers
      const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      weekdays.forEach(day => {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-weekday';
        dayEl.textContent = day;
        calendar.appendChild(dayEl);
      });

      // Get first day of month and number of days
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      
      // Add padding days from previous month
      const padding = firstDay.getDay();
      const prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0);
      for (let i = padding - 1; i >= 0; i--) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day other-month';
        dayEl.textContent = prevMonth.getDate() - i;
        calendar.appendChild(dayEl);
      }

      // Add days of current month
      for (let i = 1; i <= lastDay.getDate(); i++) {
        const dayEl = document.createElement('div');
        const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
        dayEl.className = 'calendar-day';
        
        if (formatDate(date) === formatDate(new Date())) {
          dayEl.classList.add('today');
        }
        if (formatDate(date) === formatDate(selectedDate)) {
          dayEl.classList.add('selected');
        }
        if (entries.has(formatDate(date))) {
          dayEl.classList.add('has-entry');
        }
        
        dayEl.textContent = i;
        dayEl.onclick = () => selectDay(date);
        calendar.appendChild(dayEl);
      }

      // Add padding days from next month
      const nextPadding = 42 - (padding + lastDay.getDate()); // 42 = 6 rows × 7 days
      for (let i = 1; i <= nextPadding; i++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day other-month';
        dayEl.textContent = i;
        calendar.appendChild(dayEl);
      }

      // Update month/year display
      document.querySelector('.calendar-title').textContent = currentDate.toLocaleDateString('en-US', { 
        month: 'long',
        year: 'numeric'
      });
    }

    function selectDay(date) {
      selectedDate = date;
      loadEntry();
      generateCalendar();
    }

    async function loadEntry() {
      updateEntryHeader();
      try {
        const res = await fetch(`/api/diary/${formatDate(selectedDate)}`, {
          credentials: 'include'
        });
        const entry = await res.json();
        
        if (entry && !entry.error) {
          document.getElementById('entry-title').value = entry.title || '';
          document.getElementById('entry-content').value = entry.content || '';
          document.getElementById('delete-entry').style.display = 'block';
        } else {
          document.getElementById('entry-title').value = '';
          document.getElementById('entry-content').value = '';
          document.getElementById('delete-entry').style.display = 'none';
        }
      } catch (err) {
        console.error('Error loading entry:', err);
      }
    }

    async function loadEntries() {
      try {
        const res = await fetch('/api/diary', {
          credentials: 'include'
        });
        const data = await res.json();
        entries.clear();
        data.forEach(entry => {
          entries.set(entry.date, entry);
        });
        generateCalendar();
      } catch (err) {
        console.error('Error loading entries:', err);
      }
    }

    // Event Listeners
    document.getElementById('prev-month').onclick = () => {
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1);
      generateCalendar();
    };

    document.getElementById('next-month').onclick = () => {
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1);
      generateCalendar();
    };

    document.getElementById('entry-form').onsubmit = async function(e) {
      e.preventDefault();
      const title = document.getElementById('entry-title').value.trim();
      const content = document.getElementById('entry-content').value.trim();
      const successMsg = document.getElementById('success-message');
      const errorMsg = document.getElementById('error-message');

      try {
        const res = await fetch(`/api/diary/${formatDate(selectedDate)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ title, content })
        });
        const data = await res.json();
        
        if (data.success) {
          entries.set(formatDate(selectedDate), { title, content });
          generateCalendar();
          successMsg.style.display = 'block';
          errorMsg.style.display = 'none';
          setTimeout(() => successMsg.style.display = 'none', 3000);
        } else {
          throw new Error(data.error || 'Failed to save entry');
        }
      } catch (err) {
        errorMsg.textContent = err.message || 'Error saving entry';
        errorMsg.style.display = 'block';
        successMsg.style.display = 'none';
      }
    };

    document.getElementById('delete-entry').onclick = async function() {
      if (!confirm('Are you sure you want to delete this entry?')) return;
      
      try {
        const res = await fetch(`/api/diary/${formatDate(selectedDate)}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        const data = await res.json();
        
        if (data.success) {
          entries.delete(formatDate(selectedDate));
          document.getElementById('entry-title').value = '';
          document.getElementById('entry-content').value = '';
          this.style.display = 'none';
          generateCalendar();
        }
      } catch (err) {
        console.error('Error deleting entry:', err);
      }
    };

    // Initialize
    updateEntryHeader();
    loadEntries();
  </script>
</body>
</html>
